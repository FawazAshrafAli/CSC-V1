{% extends "admin_base/base.html" %}
{% load static %}

{% block title_prefix %}CSC Center{% endblock title_prefix %}

{% block content %}

<div class="dashboard-content">
	<!-- Titlebar -->
	<div id="titlebar">
		<div class="row">
			<div class="col-md-12">
				<h2>CSC Centers</h2>
				<!-- Breadcrumbs -->
				<nav id="breadcrumbs">
					<ul>
						<li><a href="{% include "admin_components/home_link.html" %}">Home</a></li>						
						<li>CSC Center</li>
					</ul>
				</nav>
			</div>
		</div>
		{% include "admin_components/message.html" %}
	</div>

	<div class="row">
		<style>
            #pop-up-box {
                display: none;
                position:fixed;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                z-index: 999;                
                background: #f7f7f7;
                box-shadow: 0 0 5px;
                min-width: 390px;
            }

            #pop-up-box-heading {
                background-color: #fff;
                padding: 10px;
                margin: 0 0 10px 0;
            }

            .close-btn {
                position: absolute;
                top: 5px; 
                right: 5px;
                font-size: 24px;
                color: red;
                background-color: #fff;
                border: none;
                box-shadow: 0 0 1px #777;
                padding: 0 7px;        
            }

            .close-btn:hover {
                color: #fff;
                background-color: rgba(255, 0, 0, 0.485);
            }

            #pop-up-form {
                padding: 0 10px;
                padding-bottom: 5px;
            }

            #pop-up-dropdown {                
                min-height: 150px;                
            }

            #pop-up-btns {
                float: right;
                padding-bottom: 5px;
            }

            #pop-up-add-toggle {
                color: #fff;
                width: 75px;
                text-transform: uppercase;
                background: linear-gradient(to bottom, darkgreen, green, darkgreen);
                box-shadow: 0 0 5px #777;
                border: none;
            }

            #pop-up-add-toggle:hover {
                background: linear-gradient(to bottom, lime, green, darkgreen);
            }

            #pop-up-edit-toggle {
                display: none;
                color: #fff;
                width: 75px;
                text-transform: uppercase;
                background: linear-gradient(to bottom, coral, orange, coral);
                box-shadow: 0 0 5px #777;
                border: none;
            }

            #pop-up-edit-toggle:hover {
                background: linear-gradient(to bottom, yellow, orange, coral);
            }

            #pop-up-delete-toggle {
                display: none;
                color: #fff;
                width: 75px;
                text-transform: uppercase;
                background: linear-gradient(to bottom, darkred, red, darkred);
                box-shadow: 0 0 5px #777;
                border: none;
            }

            #pop-up-delete-toggle:hover {
                background: linear-gradient(to bottom, orange, red, darkred);
            }

            #pop-up-add-btn-div {
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            #pop-up-add-btn {
                color: #fff;
                text-transform: uppercase;
                background: linear-gradient(to bottom, darkgreen, green, darkgreen);
                border: none;
                margin-bottom: 5px;
            }

            #pop-up-add-btn:hover {
                background: linear-gradient(to bottom, lime, green, darkgreen);
            }

            #pop-up-cancel-btn {
                color: #fff;
                text-transform: uppercase;
                background: linear-gradient(to bottom, darkblue, blue, darkblue);
                border: none;
                margin-bottom: 5px;
            }

            #pop-up-cancel-btn:hover {
                background: linear-gradient(to bottom, steelblue, blue, darkblue);
            }
        </style>

        <!-- Pop Up Box Start -->
        <div id="pop-up-box">
            <h3 id="pop-up-box-heading" ></h3>
            <button class="close-btn" aria-label="Close" title="Close">&times;</button>
            <small style="padding-left: 10px;"><span id="pop-up-msg" >Message</span></small>
            <form id="pop-up-form"> </form>
        </div>
        <!-- Pop Up Box Start -->

		<div class="col-lg-9 col-md-8 padding-right-30">
            <div class="dashboard-list-box margin-top-0">
				<h4>CSC Centers</h4>
				<ul>
					{% for blog in blogs %}
					<li>				
						<div class="list-box-listing">
							<div class="list-box-listing-img" style="display: flex; flex-direction: column;">
								<a href="#"><img src={% if blog.image %} {{blog.image.url}} {% else %} "images/listing-item-01.jpg" {% endif %} alt=""></a>
								<button id="blog-status-btn-{{blog.slug}}" style="{% if blog.status == 'Published' %} background-color:green; {% else %} background-color: darkred; {% endif %} color: #fff; border: 0;">{{blog.status}}</button>
							</div>
							<div class="list-box-listing-content">
								<div class="inner">
									<h3><a href="{% url 'csc_admin:blog' blog.slug %}">{{blog.title}}</a></h3>
									<p>{{blog.summary}}</p>
								</div>
							</div>
						</div>
						<div class="buttons-to-right">
							
							<a href="#" id="toggle-change-blog-status-btn-{{blog.slug}}" class="button gray" {% if blog.status == 'Published' %} onclick="(e) => e.preventDefault(); toggleSetDraft(`{{blog.slug}}`, `{{blog.title}}`);"><i class="fas fa-file-alt"></i> Keep as Draft {% else %} onclick="(e) => e.preventDefault(); togglePublishBlog(`{{blog.slug}}`, `{{blog.title}}`);"><i class="fas fa-paper-plane"></i> Publish Blog {% endif %}</a>
														
							<a href="{% url 'csc_admin:update_blog' blog.slug %}" class="button gray"><i class="sl sl-icon-note"></i> Edit</a>
							<a href="#" class="button gray" onclick="(e) => e.preventDefault(); toggleBlogDeletion(`{{blog.slug}}`, `{{blog.title}}`);"><i class="sl sl-icon-close"></i> Delete</a>
						</div>
					</li>
					{% endfor %}
				</ul>
			</div>
        </div>
        <!-- Blog Posts / End -->
        <!-- Widgets -->
        <div class="col-lg-3 col-md-4">
            <div class="sidebar right">                
                <!-- Widget -->
                <div class="widget margin-top-40">
                    <h4>Geographic Details</h4>
                    <ul class="list-4 color">
                        <li><a href="#" id="toggle-state-pop-up">States</a></li>
                        <li><a href="#" id="toggle-district-pop-up">Districts</a></li>
                        <li><a href="#" id="toggle-block-pop-up">Blocks</a></li>
                    </ul>
                </div>

                <div class="widget margin-top-40">
                    <h4>CSC Details</h4>
                    <ul class="list-4 color">
                        <li><a href="#">CSC Name Type</a></li>
                        <li><a href="#">Keywords</a></li>
                    </ul>
                </div>
                <!-- Widget / End -->
                <!-- Widget / End-->
                <div class="clearfix"></div>
                <div class="margin-bottom-40"></div>
            </div>
        </div>
    </div>


		<!-- Copyrights -->
		<div class="col-md-12">
			<div class="copyrights">Â© 2021 CSCIndia. All Rights Reserved.| Powered by <a href="https://www.zentrix.in/" target="_blank">Zentrix Technologies</a></div>
		</div>
	</div>

</div>
{% endblock content %}

{% block scripts %}
<script>
    $(document).ready(() => {

        // Close pop up box
        $('.close-btn').click(() => {
            $('#pop-up-box').hide();
        });

        $(document).on('keydown', (event) => {
            if (event.key === 'Escape') {
                $('#pop-up-box').hide();
            };
        });

        // To populate select with state data on toggling state btn
        function getStates(e) {
            e.preventDefault();            
            
            $.ajax({
                type:'get',
                url:'/admin/get_all_states/',
                dataType:'json',
                success: data => {                    
                    if (data.states && Array.isArray(data.states)) {
                        $('#pop-up-dropdown').html('');
                        if ($('#state-dropdown-input')) {
                            $('#state-dropdown-input').html('<option value="" hidden disabled selected>Select State</option')
                        };
                        data.states.forEach(state => {
                            let html = `<option value="${state.id}">${state.state}</option>`;
                            $('#pop-up-dropdown').append(html);
                            if ($('#state-dropdown-input')) {
                                $('#state-dropdown-input').append(html);
                            };
                        });
                    } else {
                        $('#pop-up-dropdown').html('');
                        if ($('#state-dropdown-input')) {
                            $('#state-dropdown-input').html('')
                        };
                    };
                },
                error: (jqXHR, textStatus, errorThrow) => {
                    console.error("Error: ", textStatus, errorThrow);
                }
            });
        };

        $('#toggle-state-pop-up').click(() => {
            getStates(event);
            popUpDefaultView();
            $('#pop-up-edit-toggle').hide();
            $('#pop-up-delete-toggle').hide();
            $('#pop-up-box-heading').html('States');
            $('#pop-up-box').show();
        });

        // To populate select with district data on toggling district btn
        function getDistricts(e) {
            e.preventDefault();
            popUpDefaultView();
            $('#pop-up-edit-toggle').hide();
            $('#pop-up-delete-toggle').hide();
            $('#pop-up-box-heading').html('Districts');
            
            $.ajax({
                type:'get',
                url:'/admin/get_all_districts/',
                dataType:'json',
                success: data => {                    
                    if (data.districts && Array.isArray(data.districts)) {
                        $('#pop-up-dropdown').html('');
                        data.districts.forEach(district => {
                            let html = `<option value="${district.id}">${district.district}</option>`;
                            $('#pop-up-dropdown').append(html);
                        });
                    } else {
                        $('#pop-up-dropdown').html('');
                    };
                },
                error: (jqXHR, textStatus, errorThrow) => {
                    console.error("Error: ", textStatus, errorThrow);
                }
            });
        }
        
        $('#toggle-district-pop-up').click(() => {
            getDistricts(event);
            $('#pop-up-box').show();
        });

        // To populate select with block data on toggling block btn
        function getBlocks(e) {
            e.preventDefault();
            popUpDefaultView();
            $('#pop-up-edit-toggle').hide();
            $('#pop-up-delete-toggle').hide();
            $('#pop-up-box-heading').html('Blocks');

            $.ajax({
                type:'get',
                url:'/admin/get_all_blocks/',
                dataType:'json',
                success: data => {                    
                    if (data.blocks && Array.isArray(data.blocks)) {
                        $('#pop-up-dropdown').html('');
                        data.blocks.forEach(block => {
                            let html = `<option value="${block.id}">${block.block}</option>`;
                            $('#pop-up-dropdown').append(html);
                        });
                    } else {
                        $('#pop-up-dropdown').html('');
                    };
                },
                error: (jqXHR, textStatus, errorThrow) => {
                    console.error("Error: ", textStatus, errorThrow);
                }
            });
        };
        
        $('#toggle-block-pop-up').click(() => {
            getBlocks(event);
            $('#pop-up-box').show();
        });

        // Return to the default pop up box
        function popUpDefaultView() {
            $('#pop-up-form').html(
                `<select id="pop-up-dropdown" size=5>
                    
                </select>
                <div id="pop-up-functions">
                    <div id="pop-up-btns">
                        <button id="pop-up-add-toggle" type="button">Add</button>
                        <button id="pop-up-edit-toggle" type="button">Edit</button>
                        <button id="pop-up-delete-toggle" type="button">Delete</button>
                    </div>                    
                </div>`
            );
        };

        $(document).on('click', '#pop-up-add-toggle', function () {
            const currentItem = $('#pop-up-box-heading').html().slice(0, -1);
            $('#pop-up-form').prop('action', `/admin/add_${currentItem.toLowerCase()}`).prop('method', 'post');
            $('#pop-up-form').html('')
            $('#pop-up-form').html(
                `${(currentItem == 'District' || currentItem == 'Block') ? `<select id="state-dropdown-input"></select>` : '' }

                ${currentItem == 'Block' ? `<select id="district-dropdown-input"><option value="" hidden disabled selected>Select district</option></select>` : '' }

                ${currentItem == 'Block' ? `<textarea name="${currentItem.toLowerCase()}s" placeholder="Name of ${currentItem}s"></textarea>`
                : `<input type="text" name="${currentItem.toLowerCase()}" id="${currentItem.toLowerCase()}-input" placeholder="Name of ${currentItem}">`}                
                <div id="pop-up-add-btn-div">
                    <button id="pop-up-add-btn" type="button">Add ${currentItem.toUpperCase()}</button>
                    <button id="pop-up-cancel-btn" type="button">Cancel</button>
                </div>`
            );
            if ((currentItem == 'District' || currentItem == 'Block')) {
                getStates(event);
            }
        });

        // Return to the default item fetched form
        $(document).on('click', '#pop-up-cancel-btn', function () {
            popUpDefaultView();
            const currentItem = $('#pop-up-box-heading').html().slice(0, -1);
            if (currentItem == "State") {
                getStates(event);
            } else if (currentItem == "District") {
                getDistricts(event);
            } else if (currentItem == "Block") {
                getBlocks(event);
            };
        });

        // To show editing and deleting toggle button on option select
        function showEditAndDelete () {
            for (var i=0; i < $('#pop-up-form select')[0].options.length; i++) {
                if ($('#pop-up-form select')[0].options[i].selected == true) {
                    $('#pop-up-edit-toggle').show();
                    $('#pop-up-delete-toggle').show();
                };
            };
        };

        $(document).on('change', '#pop-up-form select', showEditAndDelete);

        // Ajax Form Submission
        function submitPopUpForm(requestType, requestUrl, data, successCallback) {
            $.ajax({
                type: requestType,
                url: requestUrl,
                data: data,
                dataType: 'json',
                success: response => {

                    if (response.error) {
                        if (successCallback) successCallback (false);
                    };

                    if (response.status == 'success') {
                        if (successCallback) successCallback (true);
                    } else {
                        if (successCallback) successCallback (false);
                    }

                    return false
                },
                error: (jqXHR, textStatus, errorThrow) => {
                    console.error('Error: ', textStatus, errorThrow);
                    if (successCallback) successCallback(false);
                },
            });
        };

        // Form submission
        $(document).on('click', '#pop-up-add-btn', () => {
            console.log('Clicked');
            const currentItem = $('#pop-up-box-heading').html().slice(0, -1);
            if (currentItem == 'State') {
                const state = $('#state-input').val();
                console.log(state);
                result = submitPopUpForm('post', '/admin/add_state/', {'state': state}, result => {
                    if (result) {
                        $('#state-input').val('');
                        $('#pop-up-msg').html('Added New State').css('color', 'green');
                    };
                });
            };
        });

        popUpDefaultView();
    });
</script>
{% endblock scripts %}